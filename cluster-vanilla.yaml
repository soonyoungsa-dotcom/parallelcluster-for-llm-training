# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: MIT-0
Region: us-east-1
Imds:
  ImdsSupport: v2.0
Image:
  Os: ubuntu2204
HeadNode:
  InstanceType: m5.8xlarge
  Networking:
    SubnetId: subnet-03804757850d3220a
    AdditionalSecurityGroups:
      - sg-0ecff221d18eb53f9
  Ssh:
    KeyName: bailey-p6poc
  LocalStorage:
    RootVolume:
      Size: 500
      DeleteOnTermination: true # that's your root and /home volume for users
  Iam:
    AdditionalIamPolicies: # grant ECR, SSM and S3 read access
      - Policy: arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      - Policy: arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
      - Policy: arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
      - Policy: arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
  CustomActions:
    OnNodeConfigured:
      Sequence:
        # EFA, Docker, Pyxis, NCCL, Grafana 설치 비활성화 (타임아웃 방지)
        # - Script: 's3://pcluster-config-scripts-198023436207/scripts/efa/install-efa-latest.sh'
        #   Args:
        #     - latest
        # - Script: 'https://raw.githubusercontent.com/aws-samples/aws-parallelcluster-post-install-scripts/main/docker/postinstall.sh'
        # - Script: 'https://raw.githubusercontent.com/aws-samples/aws-parallelcluster-post-install-scripts/main/pyxis/postinstall.sh'
        #   Args:
        #     - /fsx
        # - Script: 's3://pcluster-config-scripts-198023436207/scripts/nccl/install-nccl-shared.sh'
        #   Args:
        #     - v2.28.7-1
        #     - v1.17.2-aws
        #     - /fsx
        # - Script: 's3://pcluster-config-scripts-198023436207/scripts/grafana/post-install.sh'
        - Script: 's3://pcluster-config-scripts-198023436207/scripts/cloudwatch/install-cloudwatch-agent.sh'
          Args:
            - p6-b200-cluster
            - us-east-1
            - pcluster-config-scripts-198023436207
  Imds:
    Secured: false
Scheduling:
  Scheduler: slurm
  SlurmSettings:
    ScaledownIdletime: 60
    QueueUpdateStrategy: DRAIN
    CustomSlurmSettings:
      # Simple accounting to text file /home/slurm/slurm-job-completions.txt.
      - JobCompType: jobcomp/filetxt
      - JobCompLoc: /home/slurm/slurm-job-completions.txt
      - KillWait: 300
      - SlurmdTimeout: 600
      - UnkillableStepTimeout: 120
  SlurmQueues:
    - Name: compute-gpu
      CapacityType: CAPACITY_BLOCK
      Networking:
        SubnetIds:
          - subnet-03804757850d3220a
        PlacementGroup:
          Enabled: false  # set this to false if using a targeted ODCR
        AdditionalSecurityGroups:
          - sg-0d23acc924d9fd75b
      ComputeSettings:
        LocalStorage:
          EphemeralVolume:
            MountDir: /scratch # each instance has a local scratch on NVMe
          RootVolume:
            Size: 200
      Iam:
        AdditionalIamPolicies:
          - Policy: arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
      JobExclusiveAllocation: true
      ComputeResources:
        - Name: distributed-ml
          InstanceType: p6-b200.48xlarge
          MinCount: 2 # if min = max then capacity is maintained and will
          MaxCount: 2 # not scale down
          Efa:
            Enabled: true
          CapacityReservationTarget:
            CapacityReservationId: cr-0cf760a36c5ad9040
      CustomActions:
        OnNodeConfigured:
          Sequence:
            # EFA, Docker, Pyxis, NCCL, Grafana 설치 비활성화 (타임아웃 방지)
            # - Script: 's3://pcluster-config-scripts-198023436207/scripts/efa/install-efa-latest.sh'
            #   Args:
            #     - latest
            # - Script: 'https://raw.githubusercontent.com/aws-samples/aws-parallelcluster-post-install-scripts/main/docker/postinstall.sh'
            # - Script: 'https://raw.githubusercontent.com/aws-samples/aws-parallelcluster-post-install-scripts/main/pyxis/postinstall.sh'
            #   Args:
            #     - /fsx
            # - Script: 's3://pcluster-config-scripts-198023436207/scripts/nccl/use-shared-nccl.sh'
            #   Args:
            #     - /fsx
            # - Script: 's3://pcluster-config-scripts-198023436207/scripts/grafana/post-install.sh'
            - Script: 's3://pcluster-config-scripts-198023436207/scripts/cloudwatch/install-cloudwatch-agent.sh'
              Args:
                - p6-b200-cluster
                - us-east-1
                - pcluster-config-scripts-198023436207
        OnNodeStart:
          Sequence:
            - Script: 'https://raw.githubusercontent.com/aws-samples/aws-parallelcluster-post-install-scripts/main/pyxis/postinstall.sh'
SharedStorage:
  - Name: HomeDirs
    MountDir: /home
    StorageType: FsxOpenZfs
    FsxOpenZfsSettings:
      VolumeId: ${FSxORootVolumeId}
  - MountDir: /fsx
    Name: fsx
    StorageType: FsxLustre
    FsxLustreSettings:
      FileSystemId: fs-02bcbd6bb44c0fcf5
Monitoring:
  DetailedMonitoring: false
  Logs:
    CloudWatch:
      Enabled: true # good for debug
      RetentionInDays: 7
      DeletionPolicy: Delete
  Dashboards:
    CloudWatch:
      Enabled: true # provide basic dashboards
Tags:
  - Key: 'Grafana'
    Value: 'true'
