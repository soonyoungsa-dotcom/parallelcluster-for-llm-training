# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

AWSTemplateFormatVersion: '2010-09-09'
Description: >
  AWS ParallelCluster infrastructure for large language model development.
  Creates GPU-optimized environment with EFA-enabled compute nodes, FSx Lustre
  high-throughput storage, and security groups optimized for distributed training
  across multiple nodes.


####################
## Stack Metadata ##
####################

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: General configuration
        Parameters:
          - VPCName
      - Label:
          default: Availability Zone configuration
        Parameters:
          - PrimarySubnetAZ
      - Label:
          default: Monitoring configuration
        Parameters:
          - MonitoringType
          - SecondarySubnetAZ
          - S3BucketName
          - MonitoringKeyPair
          - AllowedIPsForMonitoringSSH
          - AllowedIPsForALB
          - SSLCertificateArn
      - Label:
          default: FSx Lustre storage configuration
        Parameters:
          - Capacity
          - PerUnitStorageThroughput
          - Compression
          - LustreVersion
      - Label:
          default: Network configuration
        Parameters:
          - CreateS3Endpoint
    ParameterLabels:
      VPCName:
        default: VPC Name
      PrimarySubnetAZ:
        default: Primary Availability Zone (Check capacity availability first!)
      MonitoringType:
        default: Monitoring Type (Self-hosting, AWS Managed Prometheus, or None)
      SecondarySubnetAZ:
        default: Secondary Availability Zone (Self-hosting only, for ALB)
      S3BucketName:
        default: S3 Bucket Name (Self-hosting only, for setup scripts)
      MonitoringKeyPair:
        default: EC2 Key Pair for Monitoring Instance SSH access (Self-hosting only)
      AllowedIPsForMonitoringSSH:
        default: Allowed IP CIDR for Monitoring Instance SSH (Self-hosting only)
      AllowedIPsForALB:
        default: Allowed IP CIDR for ALB (Grafana web access, Self-hosting only)
      SSLCertificateArn:
        default: SSL Certificate ARN for HTTPS (Self-hosting only, optional)
      Capacity:
        default: FSx Lustre Storage Capacity (GiB)
      PerUnitStorageThroughput:
        default: FSx Throughput per TiB (MB/s/TiB)
      Compression:
        default: FSx Data Compression Type
      LustreVersion:
        default: FSx Lustre Version
      CreateS3Endpoint:
        default: Create S3 VPC Endpoint

######################
## Stack Parameters ##
######################

Parameters:
  VPCName:
    Description: Name tag for your VPC
    Default: 'AWS ParallelCluster'
    Type: String

  PrimarySubnetAZ:
    Description: >
      Primary Availability Zone where ParallelCluster nodes and FSx Lustre will be deployed.
      
      IMPORTANT - Capacity Availability:
      - Capacity Blocks: MUST match the AZ of your capacity reservation
      - On-Demand/Spot: Check GPU instance availability in your target AZ (use 'aws ec2 describe-instance-type-offerings')
      - Contact your AWS account team to verify capacity availability before deployment
      - Insufficient capacity will cause ParallelCluster deployment to fail and rollback
      
      Example: us-east-1a
    Type: AWS::EC2::AvailabilityZone::Name

  MonitoringType:
    Description: >
      Select monitoring solution:
      
      'self-hosting' = Self-hosting (Prometheus/Grafana on EC2 + ALB)
        - Requires: SecondarySubnetAZ, S3BucketName, MonitoringKeyPair
        - Full control and customization
        - Cost: ~$50/month
      
      'amp-only' = AWS Managed Prometheus (AMP) only
        - Fully managed Prometheus service
        - No EC2 instance or ALB needed
        - Requires separate Grafana setup
        - Cost: ~$10-30/month (usage-based)
      
      'amp+amg' = AWS Managed Prometheus + Managed Grafana (Recommended)
        - Fully managed Prometheus + Grafana
        - No EC2 instance or ALB needed
        - Automatic integration
        - Cost: ~$60-80/month (AMP + AMG workspace)
      
      'none' = None (No monitoring infrastructure)
        - CloudWatch Logs still available
        - Cost: $0
    Type: String
    AllowedValues:
      - 'self-hosting'
      - 'amp-only'
      - 'amp+amg'
      - 'none'
    Default: 'none'

  SecondarySubnetAZ:
    Description: >
      (Optional) Secondary Availability Zone for Self-hosting monitoring with ALB.
      Required only when MonitoringType is 'self-hosting', as ALB requires at least 2 AZs for high availability.
      Must be different from PrimarySubnetAZ.
      Leave empty if using 'amp-only', 'amp+amg', or 'none'.
      Example: us-east-1b (if PrimarySubnetAZ is us-east-1a)
    Type: String
    Default: ''

  S3BucketName:
    Description: >
      (Required for Self-hosting only) S3 bucket name containing the monitoring setup scripts.
      The bucket should contain config/monitoring/setup-monitoring-instance.sh.
      This is the same bucket used for ParallelCluster custom scripts.
      Ignored when MonitoringType is 'amp-only', 'amp+amg', or 'none'.
      Example: my-pcluster-scripts
    Type: String
    Default: ''

  MonitoringKeyPair:
    Description: >
      (Required for Self-hosting only) EC2 Key Pair name for SSH access to the Monitoring Instance.
      This key will be used to connect to the monitoring server for maintenance and configuration.
      Must be an existing key pair in your AWS account.
      Ignored when MonitoringType is 'amp-only', 'amp+amg', or 'none'.
    Type: String
    Default: ''

  AllowedIPsForMonitoringSSH:
    Description: >
      (Required for Self-hosting only) IP CIDR block allowed to SSH into the Monitoring Instance.
      For security, use YOUR_IP/32 (e.g., 203.0.113.25/32) to restrict access to your IP only.
      Use 0.0.0.0/0 for open access (NOT recommended for production).
      Ignored when MonitoringType is 'amp-only', 'amp+amg', or 'none'.
    Type: String
    Default: '0.0.0.0/0'

  AllowedIPsForALB:
    Description: >
      (Required for Self-hosting only) IP CIDR block allowed to access the ALB (Grafana web interface).
      For security, use YOUR_IP/32 (e.g., 203.0.113.25/32) to restrict access to your IP only.
      Use 0.0.0.0/0 for open access (NOT recommended for production).
      Ignored when MonitoringType is 'amp-only', 'amp+amg', or 'none'.
    Type: String
    Default: '0.0.0.0/0'

  SSLCertificateArn:
    Description: >
      (Optional, Self-hosting only) ARN of an SSL/TLS certificate in AWS Certificate Manager (ACM) for HTTPS.
      If provided, ALB will use HTTPS (port 443) and redirect HTTP to HTTPS.
      Leave empty to use HTTP only (port 80).
      Ignored when MonitoringType is 'amp-only', 'amp+amg', or 'none'.
      Example: arn:aws:acm:us-east-1:123456789012:certificate/12345678-1234-1234-1234-123456789012
    Type: String
    Default: ''

  CreateS3Endpoint:
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'true'
    Description: >
      Create an S3 VPC Endpoint (Gateway Endpoint) for direct S3 access from within the VPC.
      
      'true' (Recommended): S3 traffic stays within AWS network via VPC endpoint.
        - Faster performance (lower latency)
        - No data transfer charges for S3 access
        - No internet gateway bandwidth usage
      
      'false': S3 traffic goes through NAT Gateway and internet.
        - Slower performance (higher latency)
        - NAT Gateway data processing charges apply
        - Uses NAT Gateway bandwidth
      
      Set to 'false' only if you have specific security policies requiring all traffic through NAT Gateway.
    Type: String

  Capacity:
    Description: >
      FSx Lustre storage capacity in GiB.
      Minimum: 1200 GiB, then increments of 2400 GiB (3600, 6000, 8400, etc.).
      Choose based on your dataset size and training requirements.
    Type: Number
    Default: 1200
  
  PerUnitStorageThroughput:
    Description: >
      Provisioned throughput per TiB of storage (MB/s/TiB).
      PERSISTENT_1 deployment type supports 100 or 200 MB/s/TiB.
      Higher throughput provides better I/O performance but increases cost.
      Recommended: 200 for training workloads, 100 for inference or cost optimization.
    Type: Number
    Default: 200
    AllowedValues:
      - 100
      - 200
  
  Compression:
    Description: >
      Data compression algorithm for FSx Lustre.
      LZ4: Fast compression with good compression ratio (recommended for most workloads).
      NONE: No compression, maximum performance but higher storage usage.
    Type: String
    AllowedValues:
      - "LZ4"
      - "NONE"
    Default: "LZ4"
  
  LustreVersion:
    Description: >
      Lustre file system software version.
      2.15: Latest version with improved features and performance (recommended).
      2.12: Older stable version for compatibility with legacy applications.
    Type: String
    AllowedValues:
      - "2.15"
      - "2.12"
    Default: "2.15"


###############################
## Conditions for Parameters ##
###############################

Conditions:
  S3EndpointCondition: !Equals [!Ref 'CreateS3Endpoint', 'true']
  IsSelfHosting: !Equals [!Ref 'MonitoringType', 'self-hosting']
  IsAMPOnly: !Equals [!Ref 'MonitoringType', 'amp-only']
  IsAMPAMG: !Equals [!Ref 'MonitoringType', 'amp+amg']
  IsNoMonitoring: !Equals [!Ref 'MonitoringType', 'none']
  # AMP를 사용하는 모든 경우 (amp-only 또는 amp+amg)
  UseAMP: !Or
    - !Condition IsAMPOnly
    - !Condition IsAMPAMG
  HasSecondaryAZ: !Not [!Equals [!Ref SecondarySubnetAZ, '']]
  CreateSecondarySubnet: !And
    - !Condition IsSelfHosting
    - !Condition HasSecondaryAZ
  HasSSLCertificate: !Not [!Equals [!Ref SSLCertificateArn, '']]
  NoSSLCertificate: !Equals [!Ref SSLCertificateArn, '']
  EnableALBWithSSL: !And
    - !Condition IsSelfHosting
    - !Condition HasSSLCertificate
  EnableALBWithoutSSL: !And
    - !Condition IsSelfHosting
    - !Condition NoSSLCertificate

#########################
## VPC & Network Setup ##
#########################

Mappings:
  Networking:
    VPC:
      CIDR0: 10.0.0.0/16
      CIDR1: 10.1.0.0/16

Resources:
  # Create a VPC
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      EnableDnsSupport: true
      EnableDnsHostnames: true
      CidrBlock: !FindInMap [Networking, VPC, CIDR0]
      Tags:
        - Key: Name
          Value: AWS ParallelCluster VPC

  VpcCidrBlock:
    Type: AWS::EC2::VPCCidrBlock
    DependsOn: VPC
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !FindInMap [Networking, VPC, CIDR1]


  # Create an IGW and add it to the VPC
  InternetGateway:
    Type: AWS::EC2::InternetGateway

  GatewayToInternet:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # Create a NAT GW then add it to the public subnet
  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt ElasticIP.AllocationId
      SubnetId: !Ref PublicSubnet

  ElasticIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  # Head Node Security Group
  HeadNodeSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: headnode-sg
      GroupDescription: Security Group for ParallelCluster HeadNode
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: HeadNode Security Group
  
  # HeadNode Ingress Rules (별도 리소스로 분리하여 circular dependency 방지)
  HeadNodeFromLoginNodeIngress:
    Type: AWS::EC2::SecurityGroupIngress
    DependsOn: [HeadNodeSecurityGroup, LoginNodeSecurityGroup]
    Properties:
      Description: All traffic from LoginNode
      IpProtocol: -1
      GroupId: !Ref HeadNodeSecurityGroup
      SourceSecurityGroupId: !Ref LoginNodeSecurityGroup
  
  HeadNodeFromComputeNodeIngress:
    Type: AWS::EC2::SecurityGroupIngress
    DependsOn: [HeadNodeSecurityGroup, ComputeNodeSecurityGroup]
    Properties:
      Description: All traffic from ComputeNode (Slurm communication)
      IpProtocol: -1
      GroupId: !Ref HeadNodeSecurityGroup
      SourceSecurityGroupId: !Ref ComputeNodeSecurityGroup
  
  HeadNodeFromMonitoringIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Condition: IsSelfHosting
    DependsOn: [HeadNodeSecurityGroup, MonitoringSecurityGroup]
    Properties:
      Description: Monitoring access from Monitoring instance (Prometheus scraping)
      IpProtocol: tcp
      FromPort: 9100
      ToPort: 9100
      GroupId: !Ref HeadNodeSecurityGroup
      SourceSecurityGroupId: !Ref MonitoringSecurityGroup
  


  # Compute Node Security Group (including EFA)
  ComputeNodeSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: compute-node-sg
      GroupDescription: Security Group for ParallelCluster Compute Nodes with EFA
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: ComputeNode Security Group
      SecurityGroupEgress:
        # AWS APIs
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS for AWS APIs
        # Package downloads
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP for package downloads
        # DNS
        - IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: 0.0.0.0/0
          Description: DNS queries
        # VPC internal communication
        - IpProtocol: -1
          CidrIp: !FindInMap [Networking, VPC, CIDR0]
          Description: VPC internal traffic CIDR0
        - IpProtocol: -1
          CidrIp: !FindInMap [Networking, VPC, CIDR1]
          Description: VPC internal traffic CIDR1
  # ComputeNode 간 모든 통신 허용 (EFA, NFS, 분산 학습 등)
  ComputeNodeSelfIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      Description: All traffic between compute nodes (EFA, NFS, distributed training)
      IpProtocol: -1
      GroupId: !Ref ComputeNodeSecurityGroup
      SourceSecurityGroupId: !Ref ComputeNodeSecurityGroup
  
  # HeadNode에서 ComputeNode로의 모든 통신 (NFS, Slurm, 관리 등)
  HeadNodeToComputeIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      Description: All traffic from HeadNode (NFS, Slurm, management)
      IpProtocol: -1
      GroupId: !Ref ComputeNodeSecurityGroup
      SourceSecurityGroupId: !Ref HeadNodeSecurityGroup
  
  # LoginNode에서 ComputeNode로의 모든 통신 (작업 제출, 디버깅 등)
  LoginNodeToComputeIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      Description: All traffic from LoginNode (job submission, debugging)
      IpProtocol: -1
      GroupId: !Ref ComputeNodeSecurityGroup
      SourceSecurityGroupId: !Ref LoginNodeSecurityGroup
  
  # Monitoring에서 ComputeNode로의 메트릭 수집 (Prometheus)
  MonitoringToComputeIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Condition: IsSelfHosting
    Properties:
      Description: Prometheus scraping from Monitoring instance (node_exporter)
      IpProtocol: tcp
      FromPort: 9100
      ToPort: 9100
      GroupId: !Ref ComputeNodeSecurityGroup
      SourceSecurityGroupId: !Ref MonitoringSecurityGroup
  
  MonitoringToComputeDCGMIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Condition: IsSelfHosting
    Properties:
      Description: DCGM exporter from Monitoring instance (GPU metrics)
      IpProtocol: tcp
      FromPort: 9400
      ToPort: 9400
      GroupId: !Ref ComputeNodeSecurityGroup
      SourceSecurityGroupId: !Ref MonitoringSecurityGroup

  # Login Node Security Group (Public Subnet - More Restrictive)
  # Note: SSH access control is managed in ParallelCluster configuration, not here
  LoginNodeSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: login-node-sg
      GroupDescription: Security Group for ParallelCluster LoginNodes (Public Subnet)
      VpcId: !Ref VPC
      SecurityGroupIngress:
        # SSH access - Allow from anywhere (restrict in ParallelCluster config)
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: SSH access (restrict via ParallelCluster Ssh.AllowedIps)
        # VPC internal - specific services only
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          SourceSecurityGroupId: !Ref HeadNodeSecurityGroup
          Description: NFS mount from HeadNode
        - IpProtocol: tcp
          FromPort: 6817
          ToPort: 6819
          SourceSecurityGroupId: !Ref HeadNodeSecurityGroup
          Description: Slurm communication from HeadNode
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: LoginNode Security Group
  
  LoginNodeFromMonitoringIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Condition: IsSelfHosting
    DependsOn: [LoginNodeSecurityGroup, MonitoringSecurityGroup]
    Properties:
      Description: Monitoring access from Monitoring instance (Prometheus scraping)
      IpProtocol: tcp
      FromPort: 9100
      ToPort: 9100
      GroupId: !Ref LoginNodeSecurityGroup
      SourceSecurityGroupId: !Ref MonitoringSecurityGroup
  
  # FSx Lustre Security Group
  FSxSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: fsx-lustre-sg
      GroupDescription: Security Group for FSx Lustre
      VpcId: !Ref VPC
      SecurityGroupIngress:
        # Lustre service port (988) - TCP only
        - IpProtocol: tcp
          FromPort: 988
          ToPort: 988
          CidrIp: !FindInMap [Networking, VPC, CIDR0]
          Description: Lustre service port TCP from VPC CIDR0
        - IpProtocol: tcp
          FromPort: 988
          ToPort: 988
          CidrIp: !FindInMap [Networking, VPC, CIDR1]
          Description: Lustre service port TCP from VPC CIDR1
        # Lustre management ports (1021-1023) - TCP only
        - IpProtocol: tcp
          FromPort: 1021
          ToPort: 1023
          CidrIp: !FindInMap [Networking, VPC, CIDR0]
          Description: Lustre management ports TCP from VPC CIDR0
        - IpProtocol: tcp
          FromPort: 1021
          ToPort: 1023
          CidrIp: !FindInMap [Networking, VPC, CIDR1]
          Description: Lustre management ports TCP from VPC CIDR1
        # Lustre data ports (20001-20003) - TCP and UDP
        - IpProtocol: tcp
          FromPort: 20001
          ToPort: 20003
          CidrIp: !FindInMap [Networking, VPC, CIDR0]
          Description: Lustre data TCP from VPC CIDR0
        - IpProtocol: tcp
          FromPort: 20001
          ToPort: 20003
          CidrIp: !FindInMap [Networking, VPC, CIDR1]
          Description: Lustre data TCP from VPC CIDR1
        - IpProtocol: udp
          FromPort: 20001
          ToPort: 20003
          CidrIp: !FindInMap [Networking, VPC, CIDR0]
          Description: Lustre data UDP from VPC CIDR0
        - IpProtocol: udp
          FromPort: 20001
          ToPort: 20003
          CidrIp: !FindInMap [Networking, VPC, CIDR1]
          Description: Lustre data UDP from VPC CIDR1
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: FSx Lustre Security Group

  # Build the public subnet
  PublicSubnet:
    Type: AWS::EC2::Subnet
    DependsOn: VPC
    Properties:
      MapPublicIpOnLaunch: true
      VpcId: !Ref VPC
      CidrBlock: !Select [ 0, !Cidr [ !GetAtt VPC.CidrBlock, 2, 15 ]]
      AvailabilityZone: !Ref PrimarySubnetAZ
      Tags:
        - Key: Name
          Value: !Join [ ' ', [ !Ref VPCName, 'Public Subnet -', !Ref PrimarySubnetAZ ] ]

  # Build the secondary public subnet (for ALB high availability)
  # Uses 10.0.128.0/17 (second half of 10.0.0.0/16)
  SecondaryPublicSubnet:
    Type: AWS::EC2::Subnet
    Condition: CreateSecondarySubnet
    DependsOn: VPC
    Properties:
      MapPublicIpOnLaunch: true
      VpcId: !Ref VPC
      CidrBlock: !Select [ 1, !Cidr [ !GetAtt VPC.CidrBlock, 2, 15 ]]
      AvailabilityZone: !Ref SecondarySubnetAZ
      Tags:
        - Key: Name
          Value: !Join [ ' ', [ !Ref VPCName, 'Public Subnet -', !Ref SecondarySubnetAZ ] ]

  # Create the primary private subnet
  PrimaryPrivateSubnet:
    Type: AWS::EC2::Subnet
    DependsOn: [VpcCidrBlock]
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [ 0, !Cidr [ !FindInMap [Networking, VPC, CIDR1], 2, 15 ]]
      AvailabilityZone: !Ref PrimarySubnetAZ
      Tags:
        - Key: Name
          Value: !Join [ ' ', [ !Ref VPCName, 'Private Subnet -', !Ref PrimarySubnetAZ ] ]

  # Create and set the public route table
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC

  PublicRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  # Then the private route table
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC

  PrivateRouteToInternet:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  # Associate the public route table to the public subnet
  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  # Associate the secondary public subnet to the public route table
  SecondaryPublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: CreateSecondarySubnet
    Properties:
      SubnetId: !Ref SecondaryPublicSubnet
      RouteTableId: !Ref PublicRouteTable

  # and the primary private subnet to the private route table
  PrimaryPrivateSubnetRTAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrimaryPrivateSubnet
      RouteTableId: !Ref PrivateRouteTable

  # S3 endpoint
  S3Endpoint:
    Condition: S3EndpointCondition
    Type: AWS::EC2::VPCEndpoint
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
            - Effect: Allow
              Principal: '*'
              Action:
                - '*'
              Resource:
                - '*'
      RouteTableIds:
        - !Ref PublicRouteTable
        - !Ref PrivateRouteTable
      ServiceName: !Join
        - ''
        - - com.amazonaws.
          - !Ref AWS::Region
          - .s3
      VpcId: !Ref VPC

  FSxLFilesystem:
    Type: AWS::FSx::FileSystem
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      FileSystemType: LUSTRE
      StorageType: SSD
      FileSystemTypeVersion: !Ref LustreVersion
      StorageCapacity: !Ref Capacity
      SecurityGroupIds:
        - !Ref FSxSecurityGroup
      SubnetIds:
        - !Ref PrimaryPrivateSubnet
      LustreConfiguration:
        DataCompressionType: !Ref Compression
        DeploymentType: PERSISTENT_1
        PerUnitStorageThroughput: !Ref PerUnitStorageThroughput

  # AWS Managed Prometheus (AMP) Workspace - For AMP and Managed
  AMPWorkspace:
    Type: AWS::APS::Workspace
    Condition: UseAMP
    Properties:
      Alias: !Sub ${AWS::StackName}-prometheus
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-amp-workspace
        - Key: ManagedBy
          Value: CloudFormation

  # IAM Policy for AMP remote_write access - For AMP and Managed
  AMPRemoteWritePolicy:
    Type: AWS::IAM::ManagedPolicy
    Condition: UseAMP
    Properties:
      ManagedPolicyName: !Sub ${AWS::StackName}-amp-remote-write
      Description: Allow Prometheus agents to write metrics to AMP workspace
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - aps:RemoteWrite
            Resource: !GetAtt AMPWorkspace.Arn
          - Effect: Allow
            Action:
              - aps:GetSeries
              - aps:GetLabels
              - aps:GetMetricMetadata
            Resource: !GetAtt AMPWorkspace.Arn

  # IAM Policy for AMP query access (for Grafana) - For AMP and Managed
  AMPQueryPolicy:
    Type: AWS::IAM::ManagedPolicy
    Condition: UseAMP
    Properties:
      ManagedPolicyName: !Sub ${AWS::StackName}-amp-query
      Description: Allow querying metrics from AMP workspace
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - aps:QueryMetrics
              - aps:GetSeries
              - aps:GetLabels
              - aps:GetMetricMetadata
            Resource: !GetAtt AMPWorkspace.Arn
          - Effect: Allow
            Action:
              - aps:ListWorkspaces
              - aps:DescribeWorkspace
            Resource: '*'

  # IAM Role for Managed Grafana to access AMP
  ManagedGrafanaRole:
    Type: AWS::IAM::Role
    Condition: IsAMPAMG
    Properties:
      RoleName: !Sub ${AWS::StackName}-grafana-role
      Description: IAM role for Managed Grafana to access AMP and CloudWatch
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: grafana.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId
      ManagedPolicyArns:
        - !Ref AMPQueryPolicy
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-grafana-role

  # IAM Role for Dashboard Managers (AssumeRole access to Grafana)
  GrafanaDashboardManagerRole:
    Type: AWS::IAM::Role
    Condition: IsAMPAMG
    Properties:
      RoleName: !Sub ${AWS::StackName}-dashboard-manager
      Description: IAM role for users to access Grafana as dashboard managers
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                sts:ExternalId: !Sub ${AWS::StackName}-grafana-access
      Policies:
        - PolicyName: GrafanaWorkspaceAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - grafana:DescribeWorkspace
                  - grafana:DescribeWorkspaceAuthentication
                  - grafana:DescribeWorkspaceConfiguration
                  - grafana:ListPermissions
                  - grafana:ListWorkspaces
                Resource: !Sub arn:aws:grafana:${AWS::Region}:${AWS::AccountId}:/workspaces/${ManagedGrafanaWorkspace}
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-dashboard-manager
        - Key: Purpose
          Value: Grafana Dashboard Management

  # Amazon Managed Grafana Workspace - Only for amp+amg
  ManagedGrafanaWorkspace:
    Type: AWS::Grafana::Workspace
    Condition: IsAMPAMG
    DependsOn: ManagedGrafanaRole
    Properties:
      Name: !Sub ${AWS::StackName}-grafana
      Description: Managed Grafana workspace for ParallelCluster monitoring
      AccountAccessType: CURRENT_ACCOUNT
      AuthenticationProviders:
        - AWS_SSO
      PermissionType: SERVICE_MANAGED
      RoleArn: !GetAtt ManagedGrafanaRole.Arn
      DataSources:
        - PROMETHEUS
        - CLOUDWATCH
      NotificationDestinations:
        - SNS

  # Lambda Execution Role for Grafana Data Source Setup
  GrafanaSetupLambdaRole:
    Type: AWS::IAM::Role
    Condition: IsAMPAMG
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: GrafanaDataSourceSetup
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - grafana:CreateWorkspaceApiKey
                  - grafana:DescribeWorkspace
                  - grafana:UpdateWorkspaceConfiguration
                Resource: !Sub arn:aws:grafana:${AWS::Region}:${AWS::AccountId}:/workspaces/*
              - Effect: Allow
                Action:
                  - aps:DescribeWorkspace
                Resource: !GetAtt AMPWorkspace.Arn

  # Lambda Function to Configure Grafana Data Source
  GrafanaDataSourceSetup:
    Type: AWS::Lambda::Function
    Condition: IsAMPAMG
    DependsOn:
      - ManagedGrafanaWorkspace
      - AMPWorkspace
    Properties:
      FunctionName: !Sub ${AWS::StackName}-grafana-datasource-setup
      Runtime: python3.11
      Handler: index.handler
      Role: !GetAtt GrafanaSetupLambdaRole.Arn
      Timeout: 300
      Environment:
        Variables:
          GRAFANA_WORKSPACE_ID: !GetAtt ManagedGrafanaWorkspace.Id
          AMP_WORKSPACE_ID: !GetAtt AMPWorkspace.WorkspaceId
          AMP_ENDPOINT: !GetAtt AMPWorkspace.PrometheusEndpoint
          AWS_REGION_NAME: !Ref AWS::Region
      Code:
        ZipFile: |
          import json
          import boto3
          import urllib3
          import os
          import time
          import cfnresponse
          
          http = urllib3.PoolManager()
          grafana = boto3.client('grafana')
          
          def handler(event, context):
              print(f"Event: {json.dumps(event)}")
              
              try:
                  if event['RequestType'] == 'Delete':
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      return
                  
                  workspace_id = os.environ['GRAFANA_WORKSPACE_ID']
                  amp_endpoint = os.environ['AMP_ENDPOINT']
                  region = os.environ['AWS_REGION_NAME']
                  
                  # Wait for Grafana workspace to be fully active
                  print(f"Waiting for Grafana workspace {workspace_id} to be active...")
                  for i in range(30):
                      response = grafana.describe_workspace(workspaceId=workspace_id)
                      status = response['workspace']['status']
                      print(f"Workspace status: {status}")
                      if status == 'ACTIVE':
                          break
                      time.sleep(10)
                  else:
                      raise Exception("Grafana workspace did not become active in time")
                  
                  # Get Grafana endpoint
                  grafana_endpoint = response['workspace']['endpoint']
                  print(f"Grafana endpoint: {grafana_endpoint}")
                  
                  # Create API key
                  print("Creating Grafana API key...")
                  api_key_response = grafana.create_workspace_api_key(
                      keyName='datasource-setup',
                      keyRole='ADMIN',
                      secondsToLive=3600,
                      workspaceId=workspace_id
                  )
                  api_key = api_key_response['key']
                  
                  # Configure AMP data source
                  datasource_config = {
                      "name": "Amazon Managed Prometheus",
                      "type": "prometheus",
                      "access": "proxy",
                      "url": amp_endpoint,
                      "jsonData": {
                          "httpMethod": "POST",
                          "sigV4Auth": True,
                          "sigV4AuthType": "default",
                          "sigV4Region": region
                      },
                      "isDefault": True
                  }
                  
                  # Add data source to Grafana
                  print(f"Adding AMP data source to Grafana...")
                  headers = {
                      'Authorization': f'Bearer {api_key}',
                      'Content-Type': 'application/json'
                  }
                  
                  response = http.request(
                      'POST',
                      f'https://{grafana_endpoint}/api/datasources',
                      body=json.dumps(datasource_config).encode('utf-8'),
                      headers=headers
                  )
                  
                  print(f"Response status: {response.status}")
                  print(f"Response data: {response.data.decode('utf-8')}")
                  
                  if response.status in [200, 409]:  # 409 = already exists
                      print("✓ AMP data source configured successfully")
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {
                          'DataSourceConfigured': 'true',
                          'GrafanaEndpoint': grafana_endpoint
                      })
                  else:
                      raise Exception(f"Failed to configure data source: {response.data.decode('utf-8')}")
                  
              except Exception as e:
                  print(f"Error: {str(e)}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {'Error': str(e)})

  # Custom Resource to Trigger Lambda
  GrafanaDataSourceSetupTrigger:
    Type: Custom::GrafanaDataSourceSetup
    Condition: IsAMPAMG
    DependsOn:
      - GrafanaDataSourceSetup
      - ManagedGrafanaWorkspace
    Properties:
      ServiceToken: !GetAtt GrafanaDataSourceSetup.Arn

  # Monitoring Instance Security Group (Public Subnet) - Only for Self-hosting
  MonitoringSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: IsSelfHosting
    Properties:
      GroupName: monitoring-sg
      GroupDescription: Security Group for Monitoring Instance (Prometheus, Grafana)
      VpcId: !Ref VPC
      SecurityGroupIngress:
        # SSH access
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedIPsForMonitoringSSH
          Description: SSH access from allowed IPs
        # HTTP from ALB
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: HTTP from ALB
        # HTTPS from ALB
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: HTTPS from ALB
        # Grafana from ALB
        - IpProtocol: tcp
          FromPort: 3000
          ToPort: 3000
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: Grafana from ALB
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: Monitoring Security Group

  # Application Load Balancer for Monitoring Instance - Only for Self-hosting
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: IsSelfHosting
    Properties:
      GroupName: alb-sg
      GroupDescription: Security Group for Application Load Balancer
      VpcId: !Ref VPC
      SecurityGroupIngress:
        # HTTPS access from allowed IPs
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref AllowedIPsForALB
          Description: HTTPS access from allowed IPs
        # HTTP redirect
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref AllowedIPsForALB
          Description: HTTP access from allowed IPs
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: ALB Security Group

  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Condition: IsSelfHosting
    Properties:
      Name: !Sub ${AWS::StackName}-alb
      Type: application
      Scheme: internet-facing
      IpAddressType: ipv4
      Subnets: !If
        - CreateSecondarySubnet
        - - !Ref PublicSubnet
          - !Ref SecondaryPublicSubnet
        - - !Ref PublicSubnet
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Tags:
        - Key: Name
          Value: Monitoring ALB

  # Grafana Target Group (Port 3000) - Monitoring Instance
  GrafanaTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Condition: IsSelfHosting
    Properties:
      Name: !Sub ${AWS::StackName}-grafana-tg
      Port: 3000
      Protocol: HTTP
      VpcId: !Ref VPC
      TargetType: instance
      Targets:
        - Id: !Ref MonitoringInstance
          Port: 3000
      HealthCheckEnabled: true
      HealthCheckProtocol: HTTP
      HealthCheckPath: /api/health
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Matcher:
        HttpCode: 200
      Tags:
        - Key: Name
          Value: Grafana Target Group

  # HTTP Listener with HTTPS redirect (when SSL certificate exists)
  ALBListenerHTTPWithSSL:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Condition: EnableALBWithSSL
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: 443
            StatusCode: HTTP_301

  # HTTP Listener without SSL (direct forwarding to Grafana)
  ALBListenerHTTPNoSSL:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Condition: EnableALBWithoutSSL
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref GrafanaTargetGroup

  # HTTPS Listener - Default to Grafana (only when SSL certificate exists)
  ALBListenerHTTPS:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Condition: HasSSLCertificate
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref SSLCertificateArn
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref GrafanaTargetGroup

  # Monitoring Instance - Only for Self-hosting
  MonitoringInstance:
    Type: AWS::EC2::Instance
    Condition: IsSelfHosting
    Properties:
      InstanceType: t3.medium
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64}}'
      KeyName: !If [IsSelfHosting, !Ref MonitoringKeyPair, !Ref 'AWS::NoValue']
      IamInstanceProfile: !Ref MonitoringInstanceProfile
      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: 0
          SubnetId: !Ref PublicSubnet
          GroupSet:
            - !Ref MonitoringSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-monitoring
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          
          echo "=== Monitoring Instance Setup Started ==="
          
          # Install AWS CLI if not present
          if ! command -v aws &> /dev/null; then
            yum install -y aws-cli
          fi
          
          # Download setup script from S3
          # Note: S3 bucket name should be provided via environment variable or parameter
          # For now, using a placeholder - update this after S3 bucket is created
          S3_BUCKET="${S3BucketName}"
          
          echo "Downloading setup script from s3://$S3_BUCKET/config/monitoring/setup-monitoring-instance.sh"
          aws s3 cp s3://$S3_BUCKET/config/monitoring/setup-monitoring-instance.sh /tmp/setup-monitoring-instance.sh
          
          # Make executable
          chmod +x /tmp/setup-monitoring-instance.sh
          
          # Run setup script
          echo "Running monitoring setup script..."
          bash /tmp/setup-monitoring-instance.sh ${AWS::Region}
          
          echo "✓ Monitoring Instance Setup Complete"

  # IAM Role for Monitoring Instance - Only for Self-hosting
  MonitoringInstanceRole:
    Type: AWS::IAM::Role
    Condition: IsSelfHosting
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
      Policies:
        - PolicyName: EC2DescribeForPrometheus
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ec2:DescribeInstances
                  - ec2:DescribeTags
                Resource: '*'
        - PolicyName: S3ReadScripts
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !Sub 'arn:aws:s3:::${S3BucketName}'
                  - !Sub 'arn:aws:s3:::${S3BucketName}/*'
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-monitoring-role

  MonitoringInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Condition: IsSelfHosting
    Properties:
      Roles:
        - !Ref MonitoringInstanceRole


#############
## Outputs ##
#############
Outputs:
  AWSRegion:
    Value: !Ref AWS::Region
    Description: AWS Region where the stack is deployed
    Export:
      Name: !Sub ${AWS::StackName}-AWSRegion
  VPC:
    Value: !Ref VPC
    Description: ID of the VPC
    Export:
      Name: !Sub ${AWS::StackName}-VPC
  PublicSubnet:
    Value: !Ref PublicSubnet
    Description: ID of the public subnet
    Export:
      Name: !Sub ${AWS::StackName}-PublicSubnet
  SecondaryPublicSubnet:
    Condition: CreateSecondarySubnet
    Value: !Ref SecondaryPublicSubnet
    Description: ID of the secondary public subnet (for ALB)
    Export:
      Name: !Sub ${AWS::StackName}-SecondaryPublicSubnet
  PrimaryPrivateSubnet:
    Value: !Ref PrimaryPrivateSubnet
    Description: ID of the primary private subnet
    Export:
      Name: !Sub ${AWS::StackName}-PrimaryPrivateSubnet
  HeadNodeSecurityGroup:
    Value: !Ref HeadNodeSecurityGroup
    Description: Security Group ID for HeadNode
    Export:
      Name: !Sub ${AWS::StackName}-HeadNodeSecurityGroup
  ComputeNodeSecurityGroup:
    Value: !Ref ComputeNodeSecurityGroup
    Description: Security Group ID for Compute Nodes with EFA
    Export:
      Name: !Sub ${AWS::StackName}-ComputeNodeSecurityGroup
  LoginNodeSecurityGroup:
    Value: !Ref LoginNodeSecurityGroup
    Description: Security Group ID for LoginNodes
    Export:
      Name: !Sub ${AWS::StackName}-LoginNodeSecurityGroup
  MonitoringSecurityGroup:
    Condition: IsSelfHosting
    Value: !Ref MonitoringSecurityGroup
    Description: Security Group ID for Monitoring Instance (Self-hosting only)
    Export:
      Name: !Sub ${AWS::StackName}-MonitoringSecurityGroup
  FSxSecurityGroup:
    Value: !Ref FSxSecurityGroup
    Description: Security Group ID for FSx Lustre
    Export:
      Name: !Sub ${AWS::StackName}-FSxSecurityGroup
  FSxLustreFilesystemMountname:
    Description: The ID of the FSxL filesystem that has been created
    Value: !GetAtt FSxLFilesystem.LustreMountName
    Export:
      Name: !Sub ${AWS::StackName}-FSxLustreFilesystemMountname
  FSxLustreFilesystemDNSname:
    Description: The DNS of the FSxL filesystem that has been created
    Value: !GetAtt FSxLFilesystem.DNSName
    Export:
      Name: !Sub ${AWS::StackName}-FSxLustreFilesystemDNSname
  FSxLustreFilesystemId:
    Description: The ID of the FSxL filesystem that has been created
    Value: !Ref FSxLFilesystem
    Export:
      Name: !Sub ${AWS::StackName}-FSxLustreFilesystemId
  ALBSecurityGroup:
    Condition: IsSelfHosting
    Value: !Ref ALBSecurityGroup
    Description: Security Group ID for Application Load Balancer (Self-hosting only)
    Export:
      Name: !Sub ${AWS::StackName}-ALBSecurityGroup
  ALBDNSName:
    Condition: IsSelfHosting
    Value: !GetAtt ApplicationLoadBalancer.DNSName
    Description: DNS name of the Application Load Balancer (Self-hosting only)
    Export:
      Name: !Sub ${AWS::StackName}-ALBDNSName
  GrafanaTargetGroup:
    Condition: IsSelfHosting
    Value: !Ref GrafanaTargetGroup
    Description: Target Group ARN for Grafana (Self-hosting only)
    Export:
      Name: !Sub ${AWS::StackName}-GrafanaTargetGroup
  MonitoringInstanceId:
    Condition: IsSelfHosting
    Value: !Ref MonitoringInstance
    Description: Instance ID of the Monitoring Instance (Self-hosting only)
    Export:
      Name: !Sub ${AWS::StackName}-MonitoringInstanceId
  MonitoringInstancePrivateIP:
    Condition: IsSelfHosting
    Value: !GetAtt MonitoringInstance.PrivateIp
    Description: Private IP address of the Monitoring Instance (Self-hosting only)
    Export:
      Name: !Sub ${AWS::StackName}-MonitoringInstancePrivateIP
  MonitoringInstancePublicIP:
    Condition: IsSelfHosting
    Value: !GetAtt MonitoringInstance.PublicIp
    Description: Public IP address of the Monitoring Instance for SSH access (Self-hosting only)
    Export:
      Name: !Sub ${AWS::StackName}-MonitoringInstancePublicIP
  MonitoringType:
    Value: !Ref MonitoringType
    Description: Monitoring solution type (self-hosting, amp-only, amp+amg, or none)
    Export:
      Name: !Sub ${AWS::StackName}-MonitoringType
  AMPWorkspaceId:
    Condition: UseAMP
    Value: !GetAtt AMPWorkspace.WorkspaceId
    Description: AWS Managed Prometheus Workspace ID (amp-only and amp+amg)
    Export:
      Name: !Sub ${AWS::StackName}-AMPWorkspaceId
  AMPWorkspaceArn:
    Condition: UseAMP
    Value: !GetAtt AMPWorkspace.Arn
    Description: AWS Managed Prometheus Workspace ARN (amp-only and amp+amg)
    Export:
      Name: !Sub ${AWS::StackName}-AMPWorkspaceArn
  AMPPrometheusEndpoint:
    Condition: UseAMP
    Value: !GetAtt AMPWorkspace.PrometheusEndpoint
    Description: AWS Managed Prometheus endpoint URL for remote_write (amp-only and amp+amg)
    Export:
      Name: !Sub ${AWS::StackName}-AMPPrometheusEndpoint
  AMPRemoteWritePolicyArn:
    Condition: UseAMP
    Value: !Ref AMPRemoteWritePolicy
    Description: IAM Policy ARN for AMP remote_write access (attach to ParallelCluster nodes)
    Export:
      Name: !Sub ${AWS::StackName}-AMPRemoteWritePolicyArn
  AMPQueryPolicyArn:
    Condition: UseAMP
    Value: !Ref AMPQueryPolicy
    Description: IAM Policy ARN for AMP query access (attach to Grafana)
    Export:
      Name: !Sub ${AWS::StackName}-AMPQueryPolicyArn
  ManagedGrafanaWorkspaceId:
    Condition: IsAMPAMG
    Value: !GetAtt ManagedGrafanaWorkspace.Id
    Description: Amazon Managed Grafana Workspace ID (amp+amg only)
    Export:
      Name: !Sub ${AWS::StackName}-ManagedGrafanaWorkspaceId
  ManagedGrafanaWorkspaceEndpoint:
    Condition: IsAMPAMG
    Value: !GetAtt ManagedGrafanaWorkspace.Endpoint
    Description: Amazon Managed Grafana Workspace URL (amp+amg only)
    Export:
      Name: !Sub ${AWS::StackName}-ManagedGrafanaWorkspaceEndpoint
  ManagedGrafanaWorkspaceStatus:
    Condition: IsAMPAMG
    Value: !GetAtt ManagedGrafanaWorkspace.Status
    Description: Amazon Managed Grafana Workspace Status (amp+amg only)
    Export:
      Name: !Sub ${AWS::StackName}-ManagedGrafanaWorkspaceStatus
  ManagedGrafanaRoleArn:
    Condition: IsAMPAMG
    Value: !GetAtt ManagedGrafanaRole.Arn
    Description: IAM Role ARN for Managed Grafana (amp+amg only)
    Export:
      Name: !Sub ${AWS::StackName}-ManagedGrafanaRoleArn
  GrafanaDashboardManagerRoleArn:
    Condition: IsAMPAMG
    Value: !GetAtt GrafanaDashboardManagerRole.Arn
    Description: IAM Role ARN for Dashboard Managers to access Grafana (amp+amg only)
    Export:
      Name: !Sub ${AWS::StackName}-GrafanaDashboardManagerRoleArn
  GrafanaDashboardManagerRoleName:
    Condition: IsAMPAMG
    Value: !Ref GrafanaDashboardManagerRole
    Description: IAM Role Name for Dashboard Managers (amp+amg only)
    Export:
      Name: !Sub ${AWS::StackName}-GrafanaDashboardManagerRoleName
  GrafanaAccessInstructions:
    Condition: IsAMPAMG
    Value: !Sub |
      To access Grafana as a dashboard manager:
      1. Assume the role: aws sts assume-role --role-arn ${GrafanaDashboardManagerRole.Arn} --role-session-name grafana-session --external-id ${AWS::StackName}-grafana-access
      2. Grant SSO user permissions: aws grafana update-permissions --workspace-id ${ManagedGrafanaWorkspace.Id} --update-instruction-batch '[{"action":"ADD","role":"ADMIN","users":[{"id":"your-email@example.com","type":"SSO_USER"}]}]'
      3. Access Grafana: https://${ManagedGrafanaWorkspace.Endpoint}
      
      Note: AMP data source is automatically configured during stack creation.
    Description: Instructions to access Grafana workspace (amp+amg only)
  
  GrafanaDataSourceStatus:
    Condition: IsAMPAMG
    Value: !GetAtt GrafanaDataSourceSetupTrigger.DataSourceConfigured
    Description: Status of AMP data source configuration in Grafana (amp+amg only)
  
  # Additional outputs for setup scripts
  StackName:
    Value: !Ref AWS::StackName
    Description: CloudFormation stack name (for querying outputs in setup scripts)
    Export:
      Name: !Sub ${AWS::StackName}-StackName
